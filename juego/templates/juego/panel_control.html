<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Admin - El Impostor</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
    .header { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .btn-red { background: #e74c3c; } .btn-green { background: #27ae60; } .btn-blue { background: #3498db; } 
    .btn-danger { background: #c0392b; font-size: 0.8rem; padding: 5px 10px; color: white;}
    .card { background: white; padding: 25px; margin-bottom: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #2c3e50; margin-top:0; }
    input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;}
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #f8f9fa; font-weight: bold; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    .badge { padding: 5px 10px; border-radius: 15px; color: white; font-size: 0.8rem; font-weight: bold; }
    .msg-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 80%; max-width: 600px; }
    .msg { padding: 15px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
    .msg.error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
    .word-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }

    /* --- ESTILOS DE MODALES PERSONALIZADOS --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 2px solid #e74c3c; text-align: center; box-shadow: 0 0 30px rgba(231, 76, 60, 0.3); animation: popIn 0.3s ease; color: #333; }
    @keyframes popIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }
    
    /* Botones del Modal */
    .btn-start { background: linear-gradient(45deg, #c0392b, #e74c3c); color: white; border: none; padding: 10px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .btn-modal-confirm { background: linear-gradient(45deg, #c0392b, #e74c3c); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-modal-confirm:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
    .btn-modal-cancel { background: #f0f2f5; color: #555; border: 1px solid #ccc; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-modal-cancel:hover { background: #e1e4e8; }
</style>
</head>
<body>
    <div class="msg-container">
        {% if messages %}{% for message in messages %}<div class="msg {{ message.tags }}">{{ message }}</div>{% endfor %}{% endif %}
    </div>

    <div class="header">
        <h1><i class="fas fa-cogs"></i> Panel de Control</h1>
        <a href="{% url 'logout_admin' %}" class="btn btn-red">Salir</a>
    </div>

    <div class="card">
        <h2><i class="fas fa-clock"></i> Configuración Global</h2>
        <form method="POST" style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
            {% csrf_token %}
            <div><label>Sesión (min):</label><input type="number" name="tiempo_total" value="{{ config.tiempo_sesion_minutos }}"></div>
            <div><label>Aviso (min):</label><input type="number" name="tiempo_aviso" value="{{ config.tiempo_aviso_minutos }}"></div>
            <div><label>AFK Visual (min):</label><input type="number" name="tiempo_afk_visual" value="{{ config.tiempo_afk_visual_minutos }}"></div>
            
            <div style="background: #e8f8f5; padding: 5px; border-radius: 5px; border: 1px solid #2ecc71;">
                <label><b>Tiempo Rol (seg):</b></label>
                <input type="number" name="tiempo_revelacion" value="{{ config.tiempo_revelacion_segundos }}">
            </div>

            <div style="background: #fdf2e9; padding: 5px; border-radius: 5px; border: 1px solid #e67e22;">
                <label><b>Mínimo Packs:</b></label>
                <input type="number" name="min_packs" value="{{ config.min_packs_categoria }}">
            </div>

            <button type="submit" name="update_time" class="btn btn-green">Guardar</button>
        </form>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between;">
            <h2><i class="fas fa-users"></i> Jugadores Activos</h2>
            <small style="color: #888;">Actualizando...</small>
        </div>
        <table id="playersTable">
            <thead><tr><th>Nickname</th><th>Última Actividad</th><th>Estado</th><th>Juego</th><th>Categoría</th></tr></thead>
            <tbody id="playersBody"></tbody>
        </table>
    </div>

    <div class="card">
        <h2><i class="fas fa-list"></i> Crear Categoría (Admin)</h2>
        
        <div style="background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top:0; color: #3498db;"><i class="fas fa-robot"></i> Importar con IA</h3>
            
            <div style="margin-bottom: 10px;">
                <label style="font-size: 0.9rem; color: #ccc;">¿De qué quieres la categoría?</label>
                <input type="text" id="aiTheme" placeholder="Ej: Películas de Terror, Comida Mexicana..." style="background: rgba(0,0,0,0.2); border: 1px solid #555; color: white;">
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button onclick="copyPrompt()" class="btn btn-blue" style="flex:1;"><i class="fas fa-copy"></i> Copiar Prompt</button>
                <button onclick="processAI()" class="btn btn-green" style="flex:1;"><i class="fas fa-bolt"></i> Procesar Texto</button>
            </div>
            <textarea id="aiText" style="width:100%; height:80px; background:rgba(0,0,0,0.3); border:1px solid #555; color:white; padding:10px; border-radius:5px;" placeholder="Pega aquí la respuesta de ChatGPT..."></textarea>
        </div>

        <div style="margin-bottom: 15px;">
            <input type="text" id="catName" placeholder="Nombre de la Categoría" style="font-size: 1.1rem; padding: 12px;">
        </div>

        <div style="background: #f9f9f9; padding: 15px; border-radius: 5px;">
            <label><b>Agregar Manualmente:</b></label>
            <div class="word-row">
                <input type="text" id="wMain" placeholder="Inocente" style="border-left: 3px solid #2ecc71;">
                <input type="text" id="wRel1" placeholder="Señuelo" style="border-left: 3px solid #f1c40f;">
                <input type="text" id="wRel2" placeholder="Difícil" style="border-left: 3px solid #e74c3c;">
                <button onclick="addWord()" class="btn btn-blue"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <table id="tempTable">
            <thead><tr><th>Inocente</th><th>Señuelo</th><th>Difícil</th><th></th></tr></thead>
            <tbody id="tempBody"></tbody>
        </table>
        
        <div style="margin-top: 15px; text-align: right;">
            <button onclick="saveCategory()" class="btn btn-green"><i class="fas fa-save"></i> GUARDAR TODO</button>
        </div>
    </div>

    <div class="card">
        <h2>Categorías del Sistema</h2>
        <table id="catTable">
            <thead><tr><th>Nombre</th><th>Packs</th><th>Partidas</th><th>Acción</th></tr></thead>
            <tbody id="catBody"></tbody>
        </table>
    </div>

    {% if user.is_superuser %}
    <div class="card" style="border-left: 5px solid #8e44ad;">
        <h2><i class="fas fa-user-shield"></i> Gestión Admin</h2>
        <table>
            <thead><tr><th>Usuario</th><th>Rol</th><th>Acción</th></tr></thead>
            <tbody>
                {% for admin in admins %}
                <tr>
                    <td>{{ admin.username }}</td>
                    <td><span class="badge" style="background:{% if admin.is_superuser %}#8e44ad{% else %}#3498db{% endif %};">{{ admin.is_superuser|yesno:"SUPER,MODERADOR" }}</span></td>
                    <td>{% if admin.id != user.id %}
                        <form method="POST" style="display:inline;" onsubmit="return confirmAdminDelete(event, this)">{% csrf_token %}
                            <input type="hidden" name="delete_admin_id" value="{{ admin.id }}">
                            <button class="btn-danger">X</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <br>
        <form method="POST" style="display: flex; gap: 10px;">
            {% csrf_token %}
            <input type="text" name="new_user" placeholder="Usuario" required>
            <input type="password" name="new_pass" placeholder="Contraseña" required>
            <button type="submit" name="new_admin" class="btn btn-blue">Crear Mod</button>
        </form>
    </div>
    {% endif %}

    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="alertTitle" style="color: #e74c3c; margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> Atención</h2>
            <p id="alertMessage" style="color: #333; font-size: 1.1rem; margin: 20px 0;">Error</p>
            <button class="btn-start" onclick="closeAlertModal()">Entendido</button>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay" style="z-index: 2001;">
        <div class="modal-content">
            <h2 style="color: #e74c3c; margin-top: 0;"><i class="fas fa-question-circle"></i> ¿Estás seguro?</h2>
            <p id="confirmMessage" style="color: #333; font-size: 1.1rem; margin: 20px 0;">...</p>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                <button class="btn-modal-cancel" onclick="closeConfirmModal()">Cancelar</button>
                <button id="btnConfirmAction" class="btn-modal-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // --- LÓGICA DE MODALES PERSONALIZADOS ---
        function showCustomAlert(msg, title="Atención") { 
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg; 
            document.getElementById('alertModal').style.display = 'flex'; 
        }
        function closeAlertModal() { document.getElementById('alertModal').style.display = 'none'; }
        
        let onConfirmCallback = null;
        function showCustomConfirm(msg, callback) {
            document.getElementById('confirmMessage').innerText = msg;
            onConfirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            onConfirmCallback = null;
        }
        document.getElementById('btnConfirmAction').addEventListener('click', function() {
            if (onConfirmCallback) onConfirmCallback();
            closeConfirmModal();
        });
        
        // Función especial para confirmar borrado de admin en formulario
        function confirmAdminDelete(event, form) {
            event.preventDefault(); // Detener envío
            showCustomConfirm("¿Estás seguro de eliminar a este administrador?", function() {
                form.submit(); // Enviar formulario si confirma
            });
            return false;
        }
        // ---------------------------------------

        function copyPrompt() {
            let theme = document.getElementById('aiTheme').value.trim();
            if (!theme) {
                showCustomAlert("Por favor, escribe un tema primero (ej: Animales).");
                document.getElementById('aiTheme').focus();
                return;
            }
            
            let minPacks = {{ config.min_packs_categoria }};
            const prompt = `Genera una lista de palabras para un juego de adivinanzas (tipo Impostor). Tema: ${theme}. Formato: Bloque de código texto plano. 1. Título. 2. ${minPacks} líneas EXACTAS: Inocente | Señuelo | Difícil.`;
            navigator.clipboard.writeText(prompt);
            showCustomAlert("¡Prompt copiado! Pégalo en ChatGPT/Gemini.", "Éxito");
        }

        function processAI() {
            const text = document.getElementById('aiText').value;
            const lines = text.split('\n');
            if(lines.length < 1) return showCustomAlert("Pega el texto primero");

            if(!lines[0].includes('|')) document.getElementById('catName').value = lines[0].trim();

            let count = 0;
            lines.forEach(line => {
                if(line.includes('|')) {
                    let parts = line.split('|');
                    if(parts.length >= 3) {
                        currentWords.push({ principal: parts[0].trim(), rel1: parts[1].trim(), rel2: parts[2].trim() });
                        count++;
                    }
                }
            });
            renderTempTable();
            document.getElementById('aiText').value = '';
            showCustomAlert(`Procesado: ${count} packs agregados.`, "Éxito");
        }

        let currentWords = [];

        function addWord() {
            let m = document.getElementById('wMain').value; let r1 = document.getElementById('wRel1').value; let r2 = document.getElementById('wRel2').value;
            if(!m || !r1 || !r2) return showCustomAlert("Faltan datos en las palabras.");
            currentWords.push({principal: m, rel1: r1, rel2: r2});
            renderTempTable();
            document.getElementById('wMain').value = ''; document.getElementById('wRel1').value = ''; document.getElementById('wRel2').value = '';
        }

        function renderTempTable() {
            let html = '';
            currentWords.forEach((w, i) => {
                html += `<tr><td>${w.principal}</td><td>${w.rel1}</td><td>${w.rel2}</td><td><button onclick="currentWords.splice(${i},1); renderTempTable()" style="color:red;border:none;cursor:pointer;">X</button></td></tr>`;
            });
            document.getElementById('tempBody').innerHTML = html;
        }

        function saveCategory() {
            let name = document.getElementById('catName').value;
            if(!name || currentWords.length === 0) return showCustomAlert("Falta nombre o palabras para guardar.");
            
            let fd = new FormData();
            fd.append('nombre_categoria', name);
            fd.append('lista_palabras', JSON.stringify(currentWords));
            
            fetch("{% url 'api_crear_categoria' %}", { method: 'POST', body: fd, headers: {'X-CSRFToken': '{{ csrf_token }}'} })
            .then(r => r.json()).then(data => {
                if(data.status === 'ok') {
                    showCustomAlert("¡Categoría guardada correctamente!", "Éxito");
                    currentWords = []; document.getElementById('catName').value = ''; renderTempTable(); loadCategories();
                } else showCustomAlert(data.msg, "Error al guardar");
            });
        }

        function loadCategories() {
            fetch("{% url 'api_listar_categorias' %}").then(r => r.json()).then(data => {
                let html = '';
                data.categorias.forEach(c => {
                    html += `<tr><td>${c.nombre}</td><td>${c.total}</td><td style="color:#00d2ff;font-weight:bold;">${c.jugada}</td>
                    <td><button onclick="deleteCat(${c.id})" class="btn-danger">Borrar</button></td></tr>`;
                });
                document.getElementById('catBody').innerHTML = html;
            });
        }

        function deleteCat(id) {
            showCustomConfirm("¿Estás seguro de que quieres borrar esta categoría?", function() {
                let fd = new FormData(); fd.append('id', id);
                fetch("{% url 'api_eliminar_categoria' %}", { method: 'POST', body: fd, headers: {'X-CSRFToken': '{{ csrf_token }}'} })
                .then(() => loadCategories());
            });
        }

        function updatePlayers() {
            fetch("{% url 'api_datos_panel' %}").then(r => r.json()).then(data => {
                let html = '';
                data.jugadores.forEach(j => {
                    html += `<tr><td><b>${j.nickname}</b></td><td>${j.ultima}</td>
                    <td><span class="badge" style="background:${j.color};">${j.estado}</span></td><td>${j.juego}</td><td>${j.categoria}</td></tr>`;
                });
                document.getElementById('playersBody').innerHTML = html;
            });
        }

        setInterval(updatePlayers, 3000); updatePlayers(); loadCategories();
        setTimeout(() => { document.querySelectorAll('.msg').forEach(m => m.style.display='none'); }, 3000);
    </script>
</body>
</html>