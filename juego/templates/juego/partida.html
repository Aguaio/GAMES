<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>En Partida</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0; height: 100vh; overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            background: black; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* TARJETAS DE ESTADO */
        .game-card {
            width: 90%; max-width: 400px; height: 80vh;
            background: #1e272e; border-radius: 20px;
            display: none; /* OCULTO POR DEFECTO */
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); border: 1px solid #333;
            position: absolute;
        }
        
        .game-card.active { display: flex; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* TEXTOS */
        h1 { font-size: 2.5rem; margin-bottom: 10px; color: #fff; text-transform: uppercase; }
        h2 { color: #00d2ff; font-size: 1.8rem; margin: 20px 0; }
        p { color: #aaa; font-size: 1.2rem; line-height: 1.6; }
        
        /* ICONOS Y ROLES */
        .big-icon { font-size: 6rem; margin-bottom: 20px; transition: 0.3s; }
        
        /* Clases de Color para el ICONO */
        .icon-impostor { color: #e74c3c; text-shadow: 0 0 30px rgba(231, 76, 60, 0.5); }
        .icon-inocente { color: #2ecc71; text-shadow: 0 0 30px rgba(46, 204, 113, 0.5); }
        .icon-senuelo  { color: #f1c40f; text-shadow: 0 0 30px rgba(241, 196, 15, 0.5); }
        .icon-neutro   { color: #ecf0f1; }

        /* Texto del Rol (Siempre Neutro) */
        .role-text { 
            font-size: 3.5rem; font-weight: 900; margin: 10px 0 30px 0; 
            color: #ecf0f1; /* BLANCO/GRIS NEUTRO */
            text-shadow: 0 5px 10px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }

        .word-text { font-size: 2rem; color: #00d2ff; background: rgba(0, 210, 255, 0.1); padding: 15px 30px; border-radius: 15px; border: 1px solid rgba(0, 210, 255, 0.3); }
        .no-word { color: #e74c3c; background: rgba(231, 76, 60, 0.1); border-color: rgba(231, 76, 60, 0.3); }

        /* BOTONES */
        .btn-action {
            background: linear-gradient(45deg, #00d2ff, #0055ff); color: white; 
            padding: 20px 40px; border-radius: 50px;
            font-size: 1.5rem; font-weight: bold; border: none; cursor: pointer;
            margin-top: 30px; width: 80%; box-shadow: 0 5px 20px rgba(0, 85, 255, 0.4);
            transition: 0.2s;
        }
        .btn-action:active { transform: scale(0.95); }
        .btn-reveal { background: linear-gradient(45deg, #27ae60, #2ecc71); box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4); }

        /* TIMER CIRCULAR */
        .timer-circle {
            width: 80px; height: 80px; border-radius: 50%;
            border: 4px solid #333; display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-weight: bold; margin: 20px auto; color: #555;
        }

        /* MODAL DE VOTACIÓN */
        .rating-stars { display: flex; gap: 10px; font-size: 2.5rem; margin: 20px 0; justify-content: center; }
        .star { color: #333; cursor: pointer; transition: 0.2s; }
        .star.hover, .star.active { color: gold; text-shadow: 0 0 15px gold; }

        @media (max-width: 600px) {
            .game-card { width: 95%; padding: 15px; }
            h1 { font-size: 1.5rem; }
            .role-text { font-size: 2.8rem; }
            .big-icon { font-size: 4.5rem; }
        }
    </style>
</head>
<body>

    <script>
        // Datos inyectados desde Django
        const PLAYERS = [
            {% for j in jugadores %}
            {
                nombre: "{{ j.nombre }}",
                es_impostor: {{ j.es_impostor|yesno:"true,false" }},
                es_senuelo: {{ j.es_senuelo|yesno:"true,false" }},
                palabra: "{{ j.palabra_asignada }}"
            },
            {% endfor %}
        ];
        const REVEAL_TIME = {{ tiempo_revelacion }};
        const SENUELO_SABE = {{ partida.senuelo_sabe_rol|yesno:"true,false" }};
        const CAT_ID = {{ partida.categoria_actual.id }};
    </script>

    <div id="cardPass" class="game-card active"> 
        <div class="big-icon icon-neutro"><i class="fas fa-mobile-alt"></i></div>
        <p style="text-transform: uppercase; letter-spacing: 2px;">PÁSALE EL DISPOSITIVO A:</p>
        <h1 id="passName" style="font-size: 3rem; color: #00d2ff; margin: 20px 0;">...</h1>
        <p style="font-size: 0.9rem; color: #666;">(Nadie más debe mirar la pantalla)</p>
        <button class="btn-action" onclick="showReveal()">SOY YO</button>
    </div>

    <div id="cardReveal" class="game-card">
        <div style="font-size: 0.9rem; color: #888; text-transform: uppercase; margin-bottom: -10px;">Tu eres:</div>
        
        <div id="roleIcon" class="big-icon"><i class="fas fa-user"></i></div>
        
        <div id="roleTitle" class="role-text">...</div>
        
        <p style="margin-bottom: 10px;">Tu palabra secreta es:</p>
        <div id="roleWord" class="word-text">...</div>
        
        <div class="timer-circle" id="timerDisplay">5</div>
    </div>

    <div id="cardGameOn" class="game-card">
        <div class="big-icon" style="color: #00d2ff;"><i class="fas fa-comments"></i></div>
        <h1 style="color: #00d2ff;">¡A JUGAR!</h1>
        <p>Todos han visto sus roles.</p>
        
        <div style="margin: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; width: 100%; box-sizing: border-box;">
            <p style="margin:0; font-size: 0.9rem; color: #aaa;">Categoría:</p>
            
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;">
                <h2 id="finalCategoryText" style="margin: 0; color: white; letter-spacing: 2px;">••••••••••</h2>
                
                <button onclick="toggleCategory()" style="background: none; border: 1px solid #555; color: #00d2ff; padding: 10px; border-radius: 50%; cursor: pointer; transition: 0.3s;">
                    <i id="eyeIcon" class="fas fa-eye"></i>
                </button>
            </div>
        </div>

        <button onclick="openRating()" class="btn-action btn-reveal" style="font-size: 1.1rem; background: #e74c3c;">
            TERMINAR PARTIDA
        </button>
    </div>

    <div id="cardRating" class="game-card">
        <h2 style="color:gold;">Partida Finalizada</h2>
        <p>¿Qué te pareció la categoría<br><b style="color:white;">{{ partida.categoria_actual.nombre }}</b>?</p>
        
        <div class="rating-stars" id="starsContainer">
            <i class="fas fa-star star" data-val="1" onclick="vote(1)"></i>
            <i class="fas fa-star star" data-val="2" onclick="vote(2)"></i>
            <i class="fas fa-star star" data-val="3" onclick="vote(3)"></i>
            <i class="fas fa-star star" data-val="4" onclick="vote(4)"></i>
            <i class="fas fa-star star" data-val="5" onclick="vote(5)"></i>
        </div>

        <button onclick="submitAndExit()" class="btn-action">SALIR AL MENÚ</button>
    </div>

    <script>
        let currentIndex = 0;
        let timerInterval;
        let selectedVote = 0;

        function showCard(cardId) {
            document.querySelectorAll('.game-card').forEach(el => el.classList.remove('active'));
            document.getElementById(cardId).classList.add('active');
        }

        function updatePassCard() {
            if (currentIndex >= PLAYERS.length) {
                showCard('cardGameOn'); 
                return;
            }
            document.getElementById('passName').innerText = PLAYERS[currentIndex].nombre;
            showCard('cardPass');
        }

        // --- LÓGICA DE ROLES Y COLORES ---
        function showReveal() {
            let p = PLAYERS[currentIndex];
            let roleTitle = "INOCENTE";
            let iconClass = "icon-inocente"; // Por defecto Verde
            let iconName = "fa-user";
            let wordText = p.palabra;
            let wordClass = "word-text";

            if (p.es_impostor) {
                roleTitle = "IMPOSTOR";
                iconClass = "icon-impostor"; // Rojo
                iconName = "fa-user-secret";
                wordText = "NO TIENES PALABRA";
                wordClass = "word-text no-word";
            } 
            else if (p.es_senuelo) {
                if (SENUELO_SABE) {
                    // Si sabe: Amarillo y texto SEÑUELO
                    roleTitle = "SEÑUELO";
                    iconClass = "icon-senuelo"; 
                    iconName = "fa-user-ninja";
                } else {
                    // Si NO sabe: Se disfraza de inocente (Verde y texto INOCENTE)
                    roleTitle = "INOCENTE"; 
                    iconClass = "icon-inocente"; 
                    iconName = "fa-user";
                }
            }

            // Aplicar cambios al DOM
            document.getElementById('roleTitle').innerText = roleTitle;
            
            // Icono: Cambiar clase de color e icono FontAwesome
            let iconContainer = document.getElementById('roleIcon');
            iconContainer.className = "big-icon " + iconClass;
            iconContainer.innerHTML = `<i class="fas ${iconName}"></i>`;
            
            // Palabra
            let wordEl = document.getElementById('roleWord');
            wordEl.innerText = wordText;
            wordEl.className = wordClass;

            showCard('cardReveal');
            startTimer();
        }

        function startTimer() {
            let timeLeft = REVEAL_TIME;
            let display = document.getElementById('timerDisplay');
            display.innerText = timeLeft;
            display.style.color = "#fff";
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                display.innerText = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishTurn();
                }
            }, 1000);
        }

        function finishTurn() {
            currentIndex++;
            updatePassCard();
        }

        function openRating() { showCard('cardRating'); }

        function vote(val) {
            selectedVote = val;
            document.querySelectorAll('.star').forEach(s => {
                let sVal = parseInt(s.getAttribute('data-val'));
                if(sVal <= val) s.classList.add('active');
                else s.classList.remove('active');
            });
        }

        function submitAndExit() {
            // Si el usuario seleccionó alguna estrella
            if(selectedVote > 0) {
                let fd = new FormData();
                fd.append('categoria_id', CAT_ID);
                fd.append('puntos', selectedVote);

                // Opción 1: Usar sendBeacon (Ideal para cerrar páginas, no se cancela)
                if (navigator.sendBeacon) {
                    // Django necesita el token en el form data para sendBeacon a veces
                    fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    navigator.sendBeacon("{% url 'api_votar_categoria' %}", fd);
                    
                    // Nos vamos inmediatamente
                    window.location.href = "{% url 'sala_espera' %}";
                } 
                else {
                    // Opción 2 (Fallback): Fetch con espera (Wait)
                    fetch("{% url 'api_votar_categoria' %}", {
                        method: 'POST',
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        body: fd
                    }).then(() => {
                        // SOLO nos vamos cuando el servidor responda "OK"
                        window.location.href = "{% url 'sala_espera' %}";
                    }).catch(err => {
                        console.error("Error votando:", err);
                        // Nos vamos igual aunque falle, para no atrapar al usuario
                        window.location.href = "{% url 'sala_espera' %}";
                    });
                }
            } else {
                // Si no votó nada, salir directo
                window.location.href = "{% url 'sala_espera' %}";
            }
        }

        // Iniciar
        updatePassCard();
        setInterval(() => { fetch("{% url 'api_ping' %}"); }, 10000);
    </script>
</body>

</html>
